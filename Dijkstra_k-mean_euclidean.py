# Loading the required modules

import psycopg2

from DB_connection_parameters import user, password, host, port, database3
import numpy as np

from sklearn.decomposition import PCA
import matplotlib.pyplot as plt
from kmean import kmeans

try:
    connection = psycopg2.connect(user=user, password=password, host=host, port=port, database=database3)
    cursor = connection.cursor()

    n = 1000  # ile punktów
    k = 5  # ile klas
    no_of_iterations = 15  # ile iteracji

    cursor.execute(
        # f'SELECT id, geom, ST_AsText(ST_PointN(geom,1)), ST_AsText(geom) FROM public."500m_g" where id in (1330304, 4802327, 1430412, 4747224, 2430236, 1250323, 1520984, 764678, 1018929, 1382920, 289954, 2337235, 627569, 1249795, 4725844, 1810691, 805463, 1419216, 877282, 1112898, 2289451, 1857488, 280363, 286176, 2052348, 4630445, 1810661, 629570, 928357, 1383820, 1521302, 1600495, 1338729, 614495, 1810693, 805404, 282444, 4795348, 1069210, 2246751, 1472045, 295622, 1390117, 1660990, 2337313, 2096112, 4802384, 4666237, 4755778, 1120552, 4785518, 2195727, 1763193, 634963, 631515, 1606844, 1068188, 1703700, 4665436, 1160809, 295123, 764674, 1858012, 1159705, 1294036, 806137, 288816, 577032, 1160216, 293037, 292515, 1471506, 1603123, 2016570, 1430418, 1606346, 1332904, 1337346, 4666723, 1297472, 556360, 4785585, 1660410, 1337345, 4795329, 4666360, 4666032, 821529, 4635887, 1710060, 646224, 1471510, 4977836, 1249793, 764675, 1205049, 1206402, 631555, 928630, 1810657, 4743118, 4756569, 1068482, 4663212, 4756075, 1294013, 2052345, 1159555, 1332906, 1609932, 632226, 1709346, 1743375, 300842, 972731, 1294420, 2289405, 645725, 1383602, 1382924, 2147335, 970317, 1612374, 1205689, 1858313, 1433382, 1590971, 1384976, 1598806, 1520497, 1251369, 764955, 1519425, 1858303, 2337317, 1600491, 809687, 813187, 1709843, 1609927, 1284232, 970064, 1204772, 289932, 1068270, 4756145, 576420, 292513, 1598663, 4666722, 1426569, 809011, 4666637, 627304, 1810663, 1161170, 284165, 2337609, 1120553, 1430595, 1250208, 1068190, 281410, 1612373, 902280, 971595, 1810666, 1067212, 1709952, 1251345, 2016089, 1612189, 556362, 876343, 627304, 1109765, 631557, 299665, 709296, 1419696, 805466, 1338541, 1609348, 1703485, 614538, 764683, 1599179, 1120607, 765170, 809689, 2289200, 614884, 2052048, 1609936, 1109762, 4756235, 1250074, 577034, 4749049, 969353, 1858192, 1068965, 1921955, 4660007, 4743168, 282435, 765172, 1590972, 1250085, 1068939, 902276, 928729, 1420338, 1810493, 1069238, 817802, 2051682, 1160213, 812757, 2195677, 4756546, 289947, 1284297, 1332924, 822632, 4756213, 282435, 1291176, 2016824, 1918572, 4974774, 968897, 970710, 4968814, 1383348, 1519388, 2196012, 4810816, 2148174, 764678, 295621, 1660410, 972974, 1426422, 902808, 1205049, 4646886, 1430417, 1105566, 1250206, 1250197, 281406, 1019095, 1710060, 1471720, 4807075, 4769490, 296216, 1382261, 1520486, 1250325, 1426835, 2088777, 1206356, 1612183, 4817006, 1206358, 1606445, 1519145, 764678, 4743118, 1120606, 1603580, 1338728, 1159787, 1383618, 805064, 1900206, 1109726, 4971850, 805406, 1382895, 299371, 628723, 1105641, 1019669, 4966477, 4725845, 2374500, 1337341, 2430233, 1068437, 2016822, 287238, 614823, 971124, 824881, 928628, 631856, 1205230, 1433196, 1332906, 1609926, 1068437, 1606496, 1332926, 653841, 1250912, 4745693, 4756145, 652726, 1423786, 1598742, 282434, 4971851, 2148169, 289952, 1600218, 1206244, 810219, 2051673, 2016572, 1120551, 812757, 902542, 1599975, 1383820, 4782025, 764675, 637362, 630927, 1068414, 293039, 2147334, 1105513, 1019574, 1427385, 646224, 4663584, 4663211, 635652, 1205604, 4769609, 1751809, 1660700, 647237, 280821, 1383110, 630929, 4756213, 1705160, 1294026, 1204933, 1205485, 1382259, 1600141, 1606839, 631515, 282434, 1609933, 1159700, 2195565, 282433, 4170605, 1334457, 877404, 1743560, 4794102, 1068567, 1810660, 1068940, 636901, 1419217, 299366, 1382919, 970065, 765169, 4653271, 199745, 971124, 876463, 1337348, 1660699, 287728, 1471320, 298097, 1419217, 4977836, 970181, 295117, 809485, 1612374, 1068792, 4666723, 1743570, 2195795, 1520144, 1660991, 1068558, 4630478, 615043, 614543, 1395026, 1519148, 1338542, 4743198, 4782062, 902812, 1520899, 1383795, 764949, 1332908, 1205049, 627313, 1338543, 614889, 806139, 1384976, 1205048, 825322, 1743570, 1159436, 4743201, 1250045, 1105643, 1704498, 300840, 4769862, 4980293, 1160603, 1067107, 876654, 1204932, 1600218, 631517, 1709952, 1019008, 970180, 1160807, 636898, 813304, 1250348, 1609347, 282440, 1068438, 817292, 1383107, 1423648, 1337519, 2016084, 876467, 4666360, 1426943, 1973333, 636901, 1419273, 970180, 1160212, 765610, 279759, 2052053, 813303, 1743572, 289931, 1068566, 4963498, 1710057, 970341, 808811, 1973700, 4170612, 1337916, 805064, 4755889, 1284361, 4974797, 615044, 1383607, 631907, 928634, 1430415, 1609352, 4665984, 820519, 1385453, 1471511, 1161105, 1250322, 576430, 4743198, 1660246, 805800, 1383616, 1520898, 1112730, 4966477, 1924598, 4807100, 1429865, 1205046)'
        # f'SELECT id,the_geom AS geom, ST_AsText(the_geom) AS geomDD FROM public."lineEdges_noded_vertices_pgr" ORDER BY random() limit {n}'
        # f'SELECT id, geom, ST_AsText(ST_PointN(geom,1)), ST_AsText(geom) FROM public."500m_g" ORDER BY random() limit {n}'
        f'SELECT id, geom AS geom, ST_AsText(geom) AS geomText FROM public."budynki_wawa_centroidy" WHERE id in '
        f'(107928, 715, 71239, 3208, 11886, 112065, 67538, 15797, 87341, 147743, 87155, 37643, 137208, 18530, 135400, 28711, 137367, 95230, 89859, 125530, 42806, 77479, 19067, 82170, 36567, 77064, 124159, 42722, 63825, 105184, 42158, 113438, 131625, 105316, 9211, 67100, 54973, 39689, 139736, 100104, 136069, 63594, 7431, 108783, 50423, 119633, 75855, 16307, 13292, 138946, 47980, 4388, 61097, 10492, 50892, 77293, 46653, 69850, 57813, 52506, 62145, 90210, 99424, 34805, 77713, 27719, 147222, 106266, 146770, 29427, 86169, 316, 115027, 106259, 97220, 35069, 23531, 38824, 42425, 135415, 64775, 10088, 68579, 63944, 20882, 48954, 68586, 102326, 95552, 84685, 33028, 79006, 10609, 27195, 142178, 53718, 51565, 65124, 91054, 80358, 67863, 147299, 46036, 25555, 31826, 147968, 45628, 113315, 104177, 81325, 126551, 105623, 126575, 129739, 96789, 119912, 33070, 38608, 91564, 134292, 8815, 73649, 18157, 7637, 19384, 83123, 31265, 88223, 60590, 110657, 5134, 12037, 3757, 68888, 6992, 87670, 106724, 86545, 16298, 101034, 40599, 91521, 104483, 119843, 3116, 124863, 2097, 61904, 29011, 109681, 37990, 186, 59256, 17699, 3758, 142361, 34536, 145098, 73165, 77333, 43298, 45837, 141959, 56363, 44138, 27475, 92870, 99413, 27582, 64700, 132987, 41320, 38522, 136415, 69086, 52959, 85119, 54593, 130010, 3377, 141228, 130591, 24534, 67867, 12587, 101123, 146602, 75313, 146843, 76762, 1781, 106624, 21465, 43094, 73603, 46881, 137103, 78889, 131771, 114754, 133205, 129922, 70504, 115008, 124971, 65766, 30377, 31732, 145042, 43134, 118945, 107873, 141899, 144874, 68102, 118665, 116281, 17781, 23675, 21766, 66841, 11280, 71235, 35180, 84597, 74085, 66009, 46269, 66093, 91810, 15890, 34612, 96807, 36364, 138932, 137404, 27289, 70736, 10770, 76396, 21972, 16104, 91554, 11604, 80444, 105518, 118701, 15716, 109837, 85360, 58202, 36793, 39424, 39724, 91195, 20270, 73186, 61705, 84886, 20510, 54176, 89713, 2305, 83812, 109341, 23704, 135778, 146409, 138864, 61991, 114064, 25838, 39346, 73447, 115358, 110089, 92346, 126775, 104381, 128435, 95310, 6554, 67701, 143193, 28441, 145026, 75099, 62113, 136894, 39339, 117918, 64455, 102128, 98028, 124421, 62803, 82102, 94893, 3282, 130716, 146217, 99769, 85658, 84173, 139806, 20430, 90407, 131150, 64052, 133803, 81173, 35514, 48739, 41539, 67198, 55174, 100727, 47923, 113366, 100871, 111181, 76015, 56534, 92201, 132062, 34890, 8652, 65831, 104957, 117138, 140604, 89567, 143244, 76286, 21421, 63613, 49476, 31512, 109989, 83711, 111210, 59911, 19262, 90200, 94368, 3137, 126993, 124265, 128244, 114167, 4514, 38484, 73444, 131507, 49573, 115646, 102824, 29370, 18968, 69193, 46957, 79803, 130358, 104018, 39018, 28563, 137592, 44755, 134103, 59721, 101648, 6603, 122496, 693, 25893, 111614, 13895, 137187, 52512, 34721, 121328, 38239, 17281, 85099, 50367, 21685, 139213, 110942, 36262, 29239, 57898, 115762, 49890, 91751, 11748, 94906, 96489, 109201, 93916, 117279, 92304, 8456, 100878, 8971, 90972, 92630, 146831, 118531, 117793, 25767, 43447, 121857, 103436, 80986, 27343, 27566, 93732, 14053, 9265, 1778, 115823, 25420, 20008, 81792, 71009, 29455, 27275, 112039, 42648, 131956, 121018, 111935, 5876, 54749, 91266, 142998, 147985, 67496, 19780, 99662, 7787, 93816, 1642, 122287, 123666, 112100, 136696, 7211, 53779, 71957, 117564, 63046, 106363, 29943, 48432, 34439, 48506, 127353, 54695, 72450, 131360, 145512, 110525, 11622, 121347, 75953, 41637, 142330, 51671, 97034, 120902, 21217, 133046, 23904, 98237, 136007, 138157, 140685, 131958, 46361, 113788, 83199, 126029, 55091, 89182, 3639, 12655, 4991, 114650, 128162, 57087, 91702, 137842, 115115, 4546, 17636, 56957, 139837, 91659, 12364, 102216, 82917, 70840, 24659, 65922, 81878, 67258, 75975, 51149, 17840, 136108, 132706, 47399, 74153, 78546, 141412, 59122, 116521, 68667, 110256, 116830, 120216, 97862, 90057, 144696, 79173, 12517, 57284, 46366, 126517, 139292, 129826, 32331, 132371, 56593, 99719, 9622, 37295, 96449, 6114, 141665, 104775, 17484, 41310, 2453, 85681, 15476, 20190, 107189, 61029, 86815, 24671, 68374, 85793, 47577, 55573, 100363, 10156, 105724, 628, 85237, 77080, 71560, 122689, 117619, 69335, 39850, 32439, 79955, 48815, 15660, 32716, 82399, 125410, 142010, 1732, 148715, 116992, 41886, 102507, 21424, 146285, 20215, 122228, 95859, 128748, 33889, 38338, 98461, 112426, 136635, 5821, 66251, 121022, 117689, 6316, 27722, 54386, 51701, 88846, 2636, 101704, 62264, 42686, 140731, 130842, 87806, 52413, 24148, 47513, 24794, 74211, 114356, 80487, 55955, 45228, 124484, 56228, 78159, 112780, 3443, 129295, 86749, 146777, 39786, 98803, 49108, 40023, 140103, 35470, 31029, 34979, 42179, 6993, 128788, 145436, 132417, 69602, 66504, 129656, 59125, 91575, 117139, 26477, 132109, 2738, 5820, 19487, 98875, 99150, 27347, 79976, 54911, 135670, 130870, 9252, 68832, 101682, 145417, 36149, 27890, 15651, 116625, 81959, 67306, 108769, 119120, 135362, 70478, 137185, 30246, 61067, 136587, 40867, 89205, 84431, 82974, 52085, 5388, 59293, 67955, 53327, 128126, 23073, 130659, 59526, 111069, 72922, 16084, 82655, 109399, 106130, 129138, 113595, 45387, 145062, 85495, 51353, 129768, 10316, 83558, 42836, 100156, 56606, 15971, 31310, 100547, 100003, 96452, 96041, 74411, 122631, 107778, 22262, 34527, 24936, 19860, 28216, 116295, 44424, 140999, 24786, 89354, 45989, 145753, 110381, 111621, 119447, 44216, 46781, 104270, 59461, 2231, 46941, 3356, 69057, 44615, 6443, 91821, 49715, 136249, 16457, 56684, 143364, 69823, 99202, 66462, 116544, 44211, 87193, 102130, 102628, 26918, 130355, 142646, 52603, 101024, 140732, 146810, 90001, 85212, 82179, 71953, 25257, 45302, 140193, 38837, 21438, 72533, 51448, 28355, 77454, 104431, 66409, 72135, 12680, 21246, 45545, 6483, 125818, 14118, 6538, 2127, 130760, 106644, 250, 26827, 17940, 45107, 57308, 139635, 118727, 83450, 44422, 89225, 145581, 19872, 117668, 25655, 140464, 52684, 33982, 67911, 118895, 88400, 19547, 572, 55324, 46740, 106085, 83608, 113078, 21778, 89257, 60423, 66819, 98488, 76206, 74986, 68962, 68656, 8457, 12128, 81347, 36062, 6929, 105093, 50934, 134946, 2011, 133258, 129946, 53651, 64594, 34677, 57267, 90517, 8569, 27354, 103194, 82481, 24714, 119430, 79602, 54879, 46675, 3504, 25450, 6303, 31515, 16915, 85952, 80867, 112833, 24119, 123718, 109551, 12591, 132630, 8999, 114429, 62261, 53908, 2283, 95698, 25594, 34079, 35429, 148739, 50562, 74987, 43373, 94026, 72413, 4429, 87587, 94434, 135229, 86875, 78909, 33735, 72427, 148655, 35224, 110410, 68058, 59881, 133709, 69969, 2445, 87346, 118351, 122943, 66906, 123106, 101452, 9126, 132097, 565, 76707, 81650, 7752, 22631, 114812, 105928, 124948, 45521, 39983, 144349, 66552, 144851, 15713, 41657, 120145, 31970, 51111, 50915, 4857, 109772, 89141, 101227, 138234, 108307, 134465, 100825, 18269, 50333, 123109, 74379, 8991, 112549, 27278, 11419, 78732, 50882, 16529, 44674, 110218, 138975, 52795, 73004, 122047, 9755, 62234, 28374, 27121, 39565, 143883, 118799, 147526, 98066, 77114, 14126, 128432, 58787, 43565, 111199, 99093, 75442, 75128, 131722, 23771, 102135, 56566, 104983, 43958, 38756, 104365, 78979, 24495, 76857, 21836, 32118, 120805, 22812, 127367, 22987, 144369, 20141, 82964, 64053, 18686, 57934, 62840, 1706, 18131, 98026, 125853, 115205, 95707, 118435, 10887, 40668, 109214, 85178, 111501, 22784, 69100, 140580, 90076) '
        f'limit {n}'
    )

    dane = cursor.fetchall()
    # print('\n sórówka z bazy danych \n', dane)

    # rozpakowuje dane
    x = [item[0] for item in dane]  # indeksy punktów
    coords = [(item[1]) for item in dane]  # współrzedne punktów
    coordsDD = [(item[2]) for item in dane]  # współrzedne punktów
    coordsDX = [[float(item[7:-1].split()[0]), float(item[7:-1].split()[1])] for item in coordsDD]
    coordsY = [float(item[6:-1].split()[0]) for item in coordsDD]
    coordsX = [float(item[7:-1].split()[1]) for item in coordsDD]
    print('Lista współrzędnych', coordsX, '\n', coordsY)
    tablica_dane = np.column_stack([coordsX, coordsY], )

    print('>>>>>>>>>>>>>>>>>>>>> to jest tablica na dane', tablica_dane)
    pca = PCA(2)
    df = pca.fit_transform(tablica_dane)
    print('>>>>>>>>>>>>>>>>>>>>> df\n', df)
    label = kmeans(tablica_dane, 5, 500)
    print('label ===================\n', label)

    u_labels = np.unique(label)
    for i in u_labels:
        plt.scatter(tablica_dane[label == i, 1], tablica_dane[label == i, 0], label=i)
    plt.legend()
    plt.grid
    plt.show()

    print('To jest df ', ())


except(Exception, psycopg2.Error) as error:
    print("Próba połączenia zakończona niepowodzeniem", error)
finally:
    # zamkniecie nawiazanego połączenia.
    if (connection):
        cursor.close()
        connection.close()
        print("Zakończono połączenie")
